<!-- === Падающие бутылки на фоне блока "Почему это важно" === -->
<canvas id="bottleCanvas"></canvas>

<script>
(() => {
  const canvas = document.getElementById('bottleCanvas');
  const ctx = canvas.getContext('2d');
  const section = document.querySelector('#about');
  let bottles = [], animationId, started = false;

  function resize() {
    canvas.width = section.offsetWidth;
    canvas.height = section.offsetHeight;
    const rect = section.getBoundingClientRect();
    canvas.style.position = 'absolute';
    canvas.style.top = rect.top + window.scrollY + 'px';
    canvas.style.left = rect.left + 'px';
    canvas.style.zIndex = 0;
    canvas.style.pointerEvents = 'none';
  }
  resize();
  window.addEventListener('resize', resize);

  const bottleImg = new Image();
  bottleImg.src = 'https://cdn-icons-png.flaticon.com/512/7741/7741900.png'; // прозрачная бутылка PNG

  class Bottle {
    constructor(x, y, size, speed, rot) {
      this.x = x;
      this.y = y;
      this.size = size;
      this.speed = speed;
      this.rot = rot;
      this.angle = Math.random() * Math.PI;
    }
    update() {
      this.y += this.speed;
      this.angle += this.rot;
    }
    draw() {
      ctx.save();
      ctx.translate(this.x, this.y);
      ctx.rotate(this.angle);
      ctx.drawImage(bottleImg, -this.size / 2, -this.size / 2, this.size, this.size * 2);
      ctx.restore();
    }
  }

  function animate() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    if (bottles.length < 60) {
      // пока не заполнилось — добавляем бутылки
      if (Math.random() < 0.3) {
        bottles.push(new Bottle(
          Math.random() * canvas.width,
          -50,
          40 + Math.random() * 30,
          1 + Math.random() * 2,
          0.01 + Math.random() * 0.02
        ));
      }
    }

    bottles.forEach((b, i) => {
      b.update();
      b.draw();
      if (b.y > canvas.height + 100) bottles.splice(i, 1); // убираем, если вышли за экран
    });

    animationId = requestAnimationFrame(animate);
  }

  function startAnimation() {
    if (!started) {
      started = true;
      bottles = [];
      animate();
    }
  }

  function stopAnimation() {
    started = false;
    cancelAnimationFrame(animationId);
    bottles = [];
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  }

  // отслеживаем видимость блока
  const observer = new IntersectionObserver(entries => {
    entries.forEach(entry => {
      if (entry.isIntersecting) startAnimation();
      else stopAnimation();
    });
  }, { threshold: 0.3 });

  observer.observe(section);
})();
</script>
