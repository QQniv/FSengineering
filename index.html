<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>FS • Счётчик + 3D фон</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header>
    <div class="logo">FS</div>
    <nav>
      <a href="#about">О проекте</a>
      <a href="#contact">Контакты</a>
    </nav>
  </header>

  <section class="hero" aria-labelledby="counter-title">
    <div class="capsule" role="group" aria-live="polite" aria-label="Счётчик выброшенных бутылок в тысячах">
      <div id="odo" class="odo"></div>
    </div>
    <h1 id="counter-title" class="subtitle">
      Именно столько тысяч пластиковых бутылок выбрасывается в России, пока вы здесь
    </h1>
  </section>

  <section class="why" id="about" aria-labelledby="why-title">
    <div class="three-bg">
      <canvas id="scene3d" aria-hidden="true"></canvas>
      <div id="fallback" class="fallback" hidden>3D временно отключена — текст и счётчик работают.</div>
    </div>
    <h2 id="why-title">Почему это важно</h2>
    <p>
      Каждую секунду — тысячи пластиковых бутылок, которые никогда не исчезнут.
      FS создаёт системы, которые очищают воду и уменьшают количество отходов,
      возвращая природе то, что ей принадлежит. Мы верим, что будущее — это не борьба с природой, а забота о ней.
    </p>
  </section>

  <!-- ===== СЧЁТЧИК ===== -->
  <script>
  (function(){
    const BPS=6000, DIGITS=6, odo=document.getElementById('odo');
    function makeDigit(){const d=document.createElement('div');d.className='digit';const s=document.createElement('div');s.className='strip';
      for(let k=0;k<10;k++){const c=document.createElement('div');c.className='cell';c.textContent=k;s.appendChild(c);}const e=document.createElement('div');e.className='cell';e.textContent='0';s.appendChild(e);d.appendChild(s);return d;}
    function build(){odo.innerHTML='';for(let i=0;i<DIGITS;i++) odo.appendChild(makeDigit());}
    build();
    let cellH=0; function measure(){const s=odo.querySelector('.cell'); if(s) cellH=Math.round(s.getBoundingClientRect().height);}
    measure(); addEventListener('resize', ()=>{measure(); setNumber(cur);});
    let prev=new Array(DIGITS).fill(0), start=performance.now(), cur=0;
    function setNumber(n){const str=Math.max(0,Math.floor(n)).toString().padStart(DIGITS,'0'); const strips=odo.querySelectorAll('.digit .strip');
      for(let i=0;i<DIGITS;i++){const st=strips[i]; const c=+str[i]; if(c!==prev[i]){st.parentElement.classList.add('anim'); st.style.transform='translate3d(0,'+(-cellH*c)+'px,0)';}}
      prev=str.split('').map(Number);
    }
    function frame(now){const t=(now-start)/1000; cur=(BPS*t)/1000; const stepped=Math.floor(cur*10)/10; setNumber(stepped); requestAnimationFrame(frame);}
    requestAnimationFrame(frame);
  })();
  </script>

  <!-- ===== 3D ПОДКЛЮЧЕНИЕ (не мешает контенту, с авто-скрытием бейджа) ===== -->
  <script src="https://unpkg.com/three@0.161.0/build/three.min.js"
          onerror="document.getElementById('fallback').hidden=false"></script>
  <script src="https://unpkg.com/three@0.161.0/examples/js/loaders/FBXLoader.js"
          onerror="document.getElementById('fallback').hidden=false"></script>

  <script>
    // авто-скрытие бейджа, чтобы не перекрывал текст
    (function(){
      const fb=document.getElementById('fallback');
      if(!fb) return;
      const show=()=>{fb.hidden=false; setTimeout(()=>fb.hidden=true, 4000);};
      if(!window.THREE || !window.FBXLoader){ show(); }
      window.addEventListener('three-ready', ()=> fb.hidden=true);
    })();
  </script>

  <script>
  (function(){
    if(!(window.THREE && window.FBXLoader)) return;

    const FBX_URL = "./model.fbx"; // положите рядом с index.html (или поправьте путь)

    const canvas = document.getElementById('scene3d');
    const renderer = new THREE.WebGLRenderer({canvas, antialias:true, alpha:true});
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(35, 16/9, 0.1, 200);
    camera.position.set(0,1.7,6);

    function resize(){
      const w=canvas.clientWidth, h=canvas.clientHeight;
      renderer.setPixelRatio(Math.min(devicePixelRatio,2));
      renderer.setSize(w,h,false);
      camera.aspect=w/h; camera.updateProjectionMatrix();
    }
    resize(); addEventListener('resize', resize, {passive:true});

    const hemi=new THREE.HemisphereLight(0xffffff,0xdde6f2,0.9); scene.add(hemi);
    const dir =new THREE.DirectionalLight(0xffffff,0.9); dir.position.set(5,10,5); dir.castShadow=true; scene.add(dir);
    const ground=new THREE.Mesh(new THREE.PlaneGeometry(30,30), new THREE.ShadowMaterial({opacity:0.22}));
    ground.rotation.x=-Math.PI/2; ground.receiveShadow=true; scene.add(ground);
    renderer.shadowMap.enabled=true;

    const loader=new FBXLoader();
    loader.load(FBX_URL,(fbx)=>{
      fbx.traverse(o=>{ if(o.isMesh){o.castShadow=true;o.receiveShadow=true;} });
      // нормируем масштаб под ~1.75м
      const box=new THREE.Box3().setFromObject(fbx), size=new THREE.Vector3(); box.getSize(size);
      const scale=1.75/Math.max(size.y||1,1e-6); fbx.scale.setScalar(scale);
      fbx.position.set(0,0,0);
      scene.add(fbx);
      window.dispatchEvent(new Event('three-ready'));
      renderer.render(scene,camera);
    });

    // рендер-цикл (если позже добавим анимацию)
    function loop(){ requestAnimationFrame(loop); renderer.render(scene,camera); }
    loop();
  })();
  </script>
</body>
</html>
